services:
  backend-prod:
    build:
      context: ./server
    container_name: backend-prod
    restart: always
    # Try without host network - use bridge network like other containers that work
    # network_mode: "host"  # Commented out - try bridge network instead
    environment:
      # Use IP address and 'das' database (like staging) - users are stored in 'das' database
      MONGODB_URI: mongodb://admin:password@192.168.29.14:27017/das?authSource=admin&authMechanism=SCRAM-SHA-256
      PORT: 5001
      NODE_ENV: production
      JWT_SECRET: bescom_distribution_automation_system_secret_key_2024
      JWT_EXPIRE: 7d
      FRONTEND_URL: https://bescomdas.vcaan.in
    ports:
      - "0.0.0.0:5001:5001"
    # Note: When using host network mode, ports are automatically exposed
    # No need to map ports separately
    healthcheck:
      test: ["CMD-SHELL", "curl -f -s --max-time 5 http://localhost:5001/health > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 240s

  frontend-prod:
    image: nginx:latest
    container_name: frontend-prod
    restart: always
    ports:
      - "0.0.0.0:4003:80"
    volumes:
      - ./dist:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      backend-prod:
        condition: service_healthy
